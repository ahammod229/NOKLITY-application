<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOKLITY Admin | Modern Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              brand: {
                red: '#D9232D', 
                black: '#111111', 
                gray: '#F3F4F6', 
              }
            }
          }
        }
      }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .nav-item.active { background-color: #D9232D; color: white; box-shadow: 0 4px 6px -1px rgba(217, 35, 45, 0.4); }
        .nav-item.active i { color: white; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
        
        /* Modal Tabs */
        .tab-btn.active { border-bottom: 2px solid #D9232D; color: #D9232D; font-weight: 600; }
        .tab-btn { color: #6B7280; font-weight: 500; }
        .dark .tab-btn { color: #9CA3AF; }
        .dark .tab-btn.active { color: #F87171; border-bottom-color: #F87171; }

        /* Settings Sidebar Active State */
        .settings-nav-item.active { background-color: #FEF2F2; color: #D9232D; font-weight: 600; border-left: 3px solid #D9232D; }
        .dark .settings-nav-item.active { background-color: #374151; color: #F87171; border-left-color: #F87171; }
        .settings-nav-item { border-left: 3px solid transparent; }
        
        /* AI Pulse Animation */
        @keyframes sparkle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .ai-loading { animation: sparkle-pulse 1s infinite; cursor: wait; }

        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800 dark:text-gray-100 bg-[#F3F4F6] dark:bg-gray-900 h-screen flex overflow-hidden transition-colors duration-200">
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-[60] flex flex-col gap-3"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
        <div class="w-full max-w-sm p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 text-center">
            <div class="flex justify-center mb-6">
                <div class="w-12 h-12 flex items-center justify-center">
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                        <path d="M20 20 V80 L50 50 L20 20 Z" fill="#D9232D"/>
                        <path d="M80 80 V20 L50 50 L80 80 Z" fill="#111111" class="dark:fill-white"/>
                    </svg>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-brand-black dark:text-white mb-1">Welcome Back</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Sign in to manage NOKLITY.</p>
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Username</label>
                    <input id="username" type="text" placeholder="Default: admin" class="mt-1 w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent outline-none transition-all dark:text-white">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">Password</label>
                    <input id="password" type="password" placeholder="Default: Ilovemoney" class="mt-1 w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red focus:border-transparent outline-none transition-all dark:text-white">
                </div>
                <p id="login-error" class="text-xs text-red-500 text-center hidden">Invalid username or password.</p>
                <button type="submit" class="w-full bg-brand-red text-white font-bold py-3 rounded-xl hover:bg-red-700 shadow-lg shadow-red-200 transition-all transform hover:-translate-y-0.5">Sign In</button>
            </form>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="flex w-full h-full hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-100 dark:border-gray-700 flex flex-col z-20 shadow-sm transition-colors duration-200">
            <div class="h-20 flex items-center px-8 border-b border-gray-50 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8" id="sidebar-logo-container">
                        <svg viewBox="0 0 100 100" fill="none" class="w-full h-full">
                            <path d="M20 20 V80 L50 50 L20 20 Z" fill="#D9232D"/>
                            <path d="M80 80 V20 L50 50 L80 80 Z" fill="#111111" class="dark:fill-white"/>
                        </svg>
                    </div>
                    <span class="font-bold text-xl text-brand-black dark:text-white tracking-tight" id="sidebar-site-name">NOKLITY</span>
                </div>
            </div>
            <nav class="flex-1 py-6 px-4 space-y-2 overflow-y-auto">
                <p class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase mb-2">Analytics</p>
                <a href="#" onclick="showSection('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-squares-four text-lg mr-3"></i> Dashboard
                </a>
                <a href="#" onclick="showSection('finance')" id="nav-finance" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-chart-line-up text-lg mr-3"></i> Finance
                </a>
                <p class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase mb-2 mt-4">Management</p>
                <a href="#" onclick="showSection('orders')" id="nav-orders" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-shopping-cart text-lg mr-3"></i> Orders
                </a>
                <a href="#" onclick="showSection('products')" id="nav-products" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-package text-lg mr-3"></i> Products
                </a>
                <a href="#" onclick="showSection('websites')" id="nav-websites" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-globe text-lg mr-3"></i> Websites
                </a>
                <a href="#" onclick="showSection('reviews')" id="nav-reviews" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-star text-lg mr-3"></i> Reviews
                </a>
                <p class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase mb-2 mt-4">System</p>
                <a href="#" onclick="showSection('marketing')" id="nav-marketing" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-megaphone text-lg mr-3"></i> Marketing
                </a>
                <a href="#" onclick="showSection('users')" id="nav-users" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-users text-lg mr-3"></i> Customers
                </a>
                <a href="#" onclick="showSection('settings')" id="nav-settings" class="nav-item flex items-center px-4 py-3 rounded-xl text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                    <i class="ph ph-gear text-lg mr-3"></i> Settings
                </a>
            </nav>
            <div class="p-4 border-t border-gray-50 dark:border-gray-700">
                <a href="#" onclick="logout()" class="flex items-center px-4 py-3 rounded-xl text-sm font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 transition-all">
                    <i class="ph ph-sign-out text-lg mr-3"></i> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full bg-[#F9FAFB] dark:bg-gray-900 overflow-hidden transition-colors duration-200">
            <header class="h-20 bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between px-8 z-10 transition-colors duration-200">
                <h1 class="text-xl font-bold text-gray-800 dark:text-white" id="page-title">Dashboard</h1>
                <div class="flex items-center gap-6">
                    <div class="relative hidden md:block">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" placeholder="Search..." class="pl-10 pr-4 py-2 w-64 bg-gray-100 dark:bg-gray-700 border-none rounded-full text-sm focus:ring-2 focus:ring-brand-red outline-none dark:text-white dark:placeholder-gray-400">
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Theme Toggle -->
                        <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 transition-all">
                            <i id="theme-icon" class="ph ph-moon text-xl"></i>
                        </button>

                        <!-- NOTIFICATION CENTER -->
                        <div class="relative">
                            <button onclick="toggleNotificationMenu()" class="w-10 h-10 rounded-full bg-gray-50 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 relative transition-all">
                                <i class="ph ph-bell text-xl"></i>
                                <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-brand-red rounded-full border-2 border-white dark:border-gray-800 hidden"></span>
                            </button>
                            <div id="notification-menu" class="hidden absolute right-0 top-12 w-80 bg-white dark:bg-gray-800 shadow-2xl rounded-xl border border-gray-100 dark:border-gray-700 z-50 overflow-hidden animate-fade-in">
                                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                                    <h4 class="font-bold text-gray-800 dark:text-white text-sm">Notifications</h4>
                                    <button onclick="clearNotifications()" class="text-xs text-brand-red hover:underline">Clear all</button>
                                </div>
                                <div id="notification-list" class="max-h-64 overflow-y-auto"></div>
                                <div id="empty-notif" class="p-6 text-center hidden">
                                    <i class="ph ph-bell-slash text-2xl text-gray-300 dark:text-gray-600 mb-2"></i>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">No new notifications</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 pl-4 border-l border-gray-200 dark:border-gray-700">
                            <img src="https://ui-avatars.com/api/?name=Admin&background=111&color=fff" id="header-avatar" class="w-10 h-10 rounded-full border-2 border-gray-100 dark:border-gray-600">
                            <div class="hidden md:block">
                                <p class="text-sm font-bold text-gray-800 dark:text-white" id="header-username">Admin</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400" id="header-role">Super Admin</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8">
                <!-- Dashboard Section -->
                <div id="section-dashboard" class="space-y-8 animate-fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-start"><div><p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Total Sales</p><h3 class="text-2xl font-bold text-gray-900 dark:text-white" id="dash-sales">৳0</h3></div><div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400"><i class="ph ph-currency-dollar text-xl"></i></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-start"><div><p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Total Orders</p><h3 class="text-2xl font-bold text-gray-900 dark:text-white" id="dash-orders">0</h3></div><div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400"><i class="ph ph-shopping-cart text-xl"></i></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-start"><div><p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Total Products</p><h3 class="text-2xl font-bold text-gray-900 dark:text-white" id="dash-products">0</h3></div><div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i class="ph ph-package text-xl"></i></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-start"><div><p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Websites</p><h3 class="text-2xl font-bold text-gray-900 dark:text-white" id="dash-websites">0</h3></div><div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400"><i class="ph ph-globe text-xl"></i></div></div>
                    </div>
                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-gray-800 dark:text-white">Revenue Analytics</h3></div>
                            <div class="h-64"><canvas id="revenueChart"></canvas></div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col justify-between">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-2">Monthly Target</h3>
                            <div class="relative h-40 w-full flex items-center justify-center">
                                <canvas id="targetChart"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pt-8"><span class="text-2xl font-bold text-gray-800 dark:text-white">85%</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Section -->
                <div id="section-finance" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Available Balance</h3><p class="text-3xl font-bold text-gray-900 dark:text-white mt-2" id="fin-balance">৳ 0</p></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Withdrawn</h3><p class="text-3xl font-bold text-gray-900 dark:text-white mt-2" id="fin-withdrawn">৳ 0</p></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700"><h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Pending Clearance</h3><p class="text-3xl font-bold text-gray-900 dark:text-white mt-2" id="fin-pending">৳ 0</p></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Actions</h2>
                        <div class="flex gap-4">
                            <form id="withdrawForm" class="flex gap-2"><input type="number" id="withdraw-amount" placeholder="Amount" class="px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"><button type="submit" class="bg-brand-red text-white px-4 py-2 rounded-lg hover:bg-red-700">Withdraw</button></form>
                            <form id="addBalanceForm" class="flex gap-2"><input type="number" id="add-amount" placeholder="Amount" class="px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"><button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Funds</button></form>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700"><h2 class="text-lg font-bold text-gray-800 dark:text-white">History</h2></div>
                        <table class="w-full text-left"><thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700"><tr><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Type</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Date</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Amount</th></tr></thead><tbody id="finance-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-300"></tbody></table>
                    </div>
                </div>

                <!-- Products Section -->
                <div id="section-products" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white">Products Inventory</h2>
                        <button onclick="openProductModal()" class="bg-brand-red text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 shadow-md transition-all flex items-center">
                            <i class="ph ph-plus mr-2"></i> Add Product
                        </button>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700"><tr><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Product</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Category</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Price</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Stock</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Status</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase text-right">Actions</th></tr></thead>
                            <tbody id="product-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="section-customers" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white">Customer Management</h2>
                        <div class="flex gap-3">
                            <button onclick="exportCustomers()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center"><i class="ph ph-download-simple mr-2"></i> Export</button>
                            <button onclick="openUserModal()" class="bg-brand-red text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 shadow-md transition-all flex items-center"><i class="ph ph-plus mr-2"></i> Add Customer</button>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center">
                        <div class="flex gap-4">
                            <div class="relative">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="customer-search" placeholder="Search by name or email..." oninput="renderCustomers()" class="pl-10 pr-4 py-2 border dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-brand-red outline-none w-64 dark:bg-gray-700 dark:text-white">
                            </div>
                            <select id="customer-status-filter" onchange="renderCustomers()" class="px-4 py-2 border dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Blocked">Blocked</option>
                            </select>
                        </div>
                        <div id="customer-bulk-actions" class="hidden">
                            <button onclick="bulkDeleteCustomers()" class="text-red-600 text-sm font-medium hover:underline">Delete Selected</button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                                <tr>
                                    <th class="px-6 py-4 w-10"><input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAllCustomers()"></th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Customer</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Joined</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Orders</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customer-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200"></tbody>
                        </table>
                        <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center">
                            <span class="text-sm text-gray-500 dark:text-gray-400" id="customer-pagination-info"></span>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 border dark:border-gray-600 rounded text-sm disabled:opacity-50 dark:text-gray-300" disabled>Prev</button>
                                <button class="px-3 py-1 border dark:border-gray-600 rounded text-sm dark:text-gray-300">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="section-users" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white">Customer Management</h2>
                        <div class="flex gap-3">
                            <button onclick="exportCustomers()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center"><i class="ph ph-download-simple mr-2"></i> Export</button>
                            <button onclick="openUserModal()" class="bg-brand-red text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 shadow-md transition-all flex items-center"><i class="ph ph-plus mr-2"></i> Add Customer</button>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center">
                        <div class="flex gap-4">
                            <div class="relative">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="user-search" placeholder="Search by name or email..." oninput="renderUsers()" class="pl-10 pr-4 py-2 border dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-brand-red outline-none w-64 dark:bg-gray-700 dark:text-white">
                            </div>
                            <select id="user-role-filter" onchange="renderUsers()" class="px-4 py-2 border dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white">
                                <option value="">All Roles</option>
                                <option value="Customer">Customer</option>
                                <option value="Admin">Admin</option>
                                <option value="Super Admin">Super Admin</option>
                            </select>
                            <select id="user-status-filter" onchange="renderUsers()" class="px-4 py-2 border dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Blocked">Blocked</option>
                            </select>
                        </div>
                        <div id="bulk-actions" class="hidden">
                            <button onclick="bulkDeleteUsers()" class="text-red-600 text-sm font-medium hover:underline">Delete Selected</button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                                <tr>
                                    <th class="px-6 py-4 w-10"><input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers()"></th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Customer</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Role</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Joined</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Orders</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200"></tbody>
                        </table>
                        <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center">
                            <span class="text-sm text-gray-500 dark:text-gray-400" id="user-pagination-info">Showing 1-10 of 20</span>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 border dark:border-gray-600 rounded text-sm disabled:opacity-50 dark:text-gray-300" disabled>Prev</button>
                                <button class="px-3 py-1 border dark:border-gray-600 rounded text-sm dark:text-gray-300">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Websites Section -->
                <div id="section-websites" class="hidden space-y-6">
                    <div class="flex justify-between items-center"><h2 class="text-lg font-bold text-gray-800 dark:text-white">Managed Websites</h2><button onclick="toggleModal('websiteModal', true)" class="bg-brand-red text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700">Add Website</button></div>
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700"><tr><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Site Name</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">URL</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Status</th><th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase text-right">Actions</th></tr></thead><tbody id="website-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200"></tbody></table></div>
                </div>

                <!-- ORDERS SECTION (With Fixes) -->
                <div id="section-orders" class="hidden space-y-8 animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Live Orders</h2>
                            <div class="flex items-center gap-2 bg-white dark:bg-gray-800 px-4 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 shadow-sm">
                                <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Open For Order</span>
                                <button onclick="toggleStoreStatus()" id="store-toggle-btn" class="relative w-11 h-6 bg-green-500 rounded-full transition-colors focus:outline-none">
                                    <span id="store-toggle-dot" class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full shadow transition-transform translate-x-5"></span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <button onclick="exportOrders()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center"><i class="ph ph-download-simple mr-2"></i> Export Orders</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-5 transition-transform hover:-translate-y-1"><div class="w-14 h-14 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 dark:text-yellow-400"><i class="ph-fill ph-shopping-bag text-2xl"></i></div><div><h3 class="text-3xl font-bold text-gray-900 dark:text-white" id="stats-total-orders">0</h3><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Orders</p></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-5 transition-transform hover:-translate-y-1"><div class="w-14 h-14 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400"><i class="ph-fill ph-clock-countdown text-2xl"></i></div><div><h3 class="text-3xl font-bold text-gray-900 dark:text-white" id="stats-pending-orders">0</h3><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Pending</p></div></div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center gap-5 transition-transform hover:-translate-y-1"><div class="w-14 h-14 rounded-full bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center text-teal-600 dark:text-teal-400"><i class="ph-fill ph-truck text-2xl"></i></div><div><h3 class="text-3xl font-bold text-gray-900 dark:text-white" id="stats-dispatch-orders">0</h3><p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Dispatch</p></div></div>
                    </div>
                    <!-- Added overflow-visible to outer container to prevent clipping -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col pb-32">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 rounded-t-2xl">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-white">Orders</h3>
                            <button class="text-sm text-gray-500 dark:text-gray-400 border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 px-3 py-1.5 rounded-lg flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-300">Recent Orders <i class="ph ph-caret-down"></i></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50/50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider">Customer</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider">Payment</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider">Time</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider text-right">Total</th>
                                        <th class="px-6 py-4 text-xs font-bold text-gray-800 dark:text-gray-200 uppercase tracking-wider text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="order-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="section-reviews" class="hidden space-y-6">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white">Reviews</h2>
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Reviewer</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Rating</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Comment</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="reviews-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Marketing Section (UPDATED WITH AI) -->
                <div id="section-marketing" class="hidden space-y-6">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white">Marketing & Content</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- AI Tool -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 col-span-1 md:col-span-2">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2"><i class="ph-fill ph-magic-wand text-brand-red"></i> AI Ad Copy Generator</h3>
                            <div class="flex gap-4 flex-col md:flex-row">
                                <input type="text" id="ai-topic" placeholder="e.g. Summer Sale for Headphones" class="flex-1 px-4 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white">
                                <button onclick="generateAdCopy()" id="ai-ad-btn" class="bg-brand-black text-white px-6 py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-800 transition-colors">
                                    <i class="ph-fill ph-sparkle"></i> ✨ Generate Ad
                                </button>
                            </div>
                            <div id="ai-result-container" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 animate-fade-in">
                                <p class="text-xs text-gray-500 dark:text-gray-400 font-bold uppercase mb-2">Generated Copy:</p>
                                <p id="ai-ad-result" class="text-sm text-gray-700 dark:text-gray-200 whitespace-pre-wrap leading-relaxed"></p>
                            </div>
                        </div>

                        <!-- Existing Banner Tool -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-4">Add Homepage Banner</h3>
                            <form id="bannerForm" class="space-y-4">
                                <input type="text" id="banner-url" placeholder="Image URL" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                                <input type="text" id="banner-link" placeholder="Link" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                                <button type="submit" class="bg-brand-black text-white px-4 py-2 rounded-lg w-full">Add Banner</button>
                            </form>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <h3 class="font-bold text-gray-800 dark:text-white mb-4">Active Banners</h3>
                            <div id="banner-list" class="space-y-3"></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <h3 class="font-bold text-gray-800 dark:text-white mb-4">Free Delivery Offer</h3>
                        <form id="freeDeliveryForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Offer Expiry Date</label>
                                <input type="date" id="offer-expiry-date" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-brand-black text-white px-4 py-2 rounded-lg">Save Offer</button>
                            </div>
                        </form>
                        <div id="active-offer-container" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div id="section-settings" class="hidden flex h-full">
                    <div class="w-64 bg-white dark:bg-gray-800 border-r border-gray-100 dark:border-gray-700 p-4 h-full">
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white mb-6 px-2">Settings</h2>
                        <div class="space-y-1">
                            <button onclick="switchSettingsTab('settings-general')" class="settings-nav-item active w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">General</button>
                            <button onclick="switchSettingsTab('settings-roles')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Users & Roles</button>
                            <button onclick="switchSettingsTab('settings-security')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Security</button>
                            <button onclick="switchSettingsTab('settings-notifications')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Notifications</button>
                            <button onclick="switchSettingsTab('settings-payment')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Payment & Billing</button>
                            <button onclick="switchSettingsTab('settings-api')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">API & Integration</button>
                            <button onclick="switchSettingsTab('settings-backup')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Backup & Restore</button>
                            <button onclick="switchSettingsTab('settings-system')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">System Preferences</button>
                            <button onclick="switchSettingsTab('settings-audit')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Audit Logs</button>
                            <button onclick="switchSettingsTab('settings-advanced')" class="settings-nav-item w-full text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">Advanced</button>
                        </div>
                    </div>
                    <div class="flex-1 p-8 overflow-y-auto">
                        <div id="settings-general" class="settings-content space-y-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">General Settings</h3>
                            <form id="generalSettingsForm" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">Site Name</label>
                                    <input type="text" id="site-name" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">Site Logo</label>
                                    <input type="file" id="site-logo-input" accept="image/*" onchange="handleLogoUpload(this)" class="w-full text-sm text-gray-500 dark:text-gray-400">
                                    <img id="site-logo-preview" class="w-16 h-16 mt-2 object-contain hidden border rounded dark:border-gray-600 bg-gray-50">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">Contact Email</label>
                                    <input type="email" id="site-email" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1 dark:text-gray-300">Currency</label>
                                    <select id="site-currency" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
                                        <option value="BDT">BDT (৳)</option>
                                        <option value="USD">USD ($)</option>
                                    </select>
                                </div>
                                <div class="flex justify-end mt-4">
                                    <button type="submit" class="bg-brand-red text-white px-6 py-2 rounded-lg hover:bg-red-700 font-medium transition-colors shadow-md">Save Changes</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- UPDATED ROLES & USER MANAGEMENT -->
                        <div id="settings-roles" class="settings-content hidden space-y-6">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-gray-800 dark:text-white">User & Role Management</h3>
                                <button onclick="openUserModal(null, true)" class="bg-brand-black text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2"><i class="ph ph-plus"></i> Add New Staff</button>
                            </div>
                            
                            <!-- Role Definitions (Visual) -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <h4 class="font-bold text-gray-700 dark:text-gray-200 mb-4">Roles & Permissions</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div><p class="font-bold dark:text-white">Super Admin</p><p class="text-xs text-gray-500 dark:text-gray-400">Full System Access</p></div>
                                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">System</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <div><p class="font-bold dark:text-white">Admin</p><p class="text-xs text-gray-500 dark:text-gray-400">Manage Products & Orders</p></div>
                                        </div>
                                        <div class="flex gap-2">
                                            <span class="text-xs bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 px-2 py-1 rounded">Can Delete</span>
                                            <span class="text-xs bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 px-2 py-1 rounded">Can Edit</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Staff List Table -->
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                                <div class="p-4 border-b border-gray-100 dark:border-gray-700"><h4 class="font-bold text-gray-700 dark:text-gray-200">Staff Members</h4></div>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                                        <tr>
                                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">User</th>
                                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Role</th>
                                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase">Status</th>
                                            <th class="px-6 py-3 text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-list-body" class="divide-y divide-gray-50 dark:divide-gray-700 dark:text-gray-200">
                                        <!-- JS will populate this -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- SECURITY SETTINGS -->
                        <div id="settings-security" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Security Settings</h3>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 space-y-4">
                                <div class="flex items-center justify-between"><span class="text-sm font-medium dark:text-gray-300">Two-Factor Authentication (2FA)</span><input type="checkbox" id="toggle-2fa" class="toggle"></div>
                                <div class="flex items-center justify-between"><span class="text-sm font-medium dark:text-gray-300">Force Password Change every 90 days</span><input type="checkbox" id="toggle-force-pass" class="toggle"></div>
                            </div>
                            
                            <!-- Change Admin Credentials Form -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 space-y-4 mt-6">
                                <h4 class="text-lg font-bold text-gray-800 dark:text-white border-b dark:border-gray-700 pb-2">Change Root Admin Credentials</h4>
                                <form id="changeCredentialsForm" class="space-y-4 pt-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Username</label>
                                        <input type="text" id="new-username" placeholder="Leave blank to keep current" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white">
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Password</label>
                                            <input type="password" id="current-password" placeholder="Required to make changes" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Password</label>
                                            <input type="password" id="new-password" placeholder="Leave blank to keep current" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:text-white">
                                        </div>
                                    </div>
                                    <div class="flex justify-end pt-2">
                                        <button type="submit" class="bg-brand-red text-white px-6 py-2 rounded-lg hover:bg-red-700 font-medium shadow-md transition-colors">Update Credentials</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div id="settings-notifications" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold dark:text-white">Notifications</h3>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 space-y-4">
                                <div class="flex justify-between items-center"><span class="text-gray-700 dark:text-gray-300 font-medium">Order Confirmation Email</span> <input type="checkbox" id="notif-email" class="toggle"></div>
                                <div class="flex justify-between items-center"><span class="text-gray-700 dark:text-gray-300 font-medium">Low Stock Alert</span> <input type="checkbox" id="notif-stock" class="toggle"></div>
                                <div class="flex justify-between items-center"><span class="text-gray-700 dark:text-gray-300 font-medium">New User Registration</span> <input type="checkbox" id="notif-user" class="toggle"></div>
                            </div>
                            <button onclick="saveNotificationSettings()" class="bg-brand-black text-white px-4 py-2 rounded-lg text-sm">Save Preferences</button>
                        </div>
                        
                        <div id="settings-payment" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold dark:text-white">Payment & Billing</h3>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 space-y-4">
                                <div><label class="block text-sm font-medium mb-1 dark:text-gray-300">Stripe Public Key</label><input type="text" id="stripe-pub" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></div>
                                <div><label class="block text-sm font-medium mb-1 dark:text-gray-300">Stripe Secret Key</label><input type="password" id="stripe-sec" class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"></div>
                                <button onclick="savePaymentSettings()" class="bg-brand-black text-white px-4 py-2 rounded-lg text-sm">Save Keys</button>
                            </div>
                        </div>
                        
                        <!-- API & INTEGRATION SECTION -->
                        <div id="settings-api" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">API & Integration</h3>
                            
                            <!-- API Key Section -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Public API Key</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Use this key to authenticate requests from your storefront.</p>
                                <div class="flex gap-2">
                                    <input type="text" id="api-key-display" readonly class="flex-1 px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-300 font-mono text-sm" value="nok_live_xxxxxxxxxxxx">
                                    <button onclick="copyApiKey()" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 flex items-center gap-2 text-sm font-medium">
                                        <i class="ph ph-copy"></i> Copy
                                    </button>
                                    <button onclick="regenerateApiKey()" class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-red-600 dark:text-red-400 px-4 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 text-sm font-medium">
                                        <i class="ph ph-arrows-clockwise"></i> Regenerate
                                    </button>
                                </div>
                            </div>

                            <!-- Webhooks Section -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-800 dark:text-white">Webhooks</h4>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Send data to external URLs when events occur.</p>
                                    </div>
                                    <button onclick="openWebhookModal()" class="bg-brand-black text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 flex items-center gap-2">
                                        <i class="ph ph-plus"></i> Add Webhook
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700">
                                            <tr>
                                                <th class="px-4 py-3 font-semibold text-gray-600 dark:text-gray-300">Endpoint URL</th>
                                                <th class="px-4 py-3 font-semibold text-gray-600 dark:text-gray-300">Events</th>
                                                <th class="px-4 py-3 font-semibold text-gray-600 dark:text-gray-300 text-right">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="webhook-list-body" class="divide-y divide-gray-50 dark:divide-gray-700">
                                            <!-- Webhook rows will be injected here -->
                                        </tbody>
                                    </table>
                                    <p id="no-webhooks-msg" class="text-center text-gray-400 py-4 text-sm hidden">No webhooks configured.</p>
                                </div>
                            </div>
                        </div>

                        <div id="settings-backup" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold dark:text-white">Backup & Restore</h3>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Download a full backup of your products, orders, and users.</p>
                                <button onclick="downloadBackup()" class="bg-brand-red text-white px-4 py-2 rounded flex items-center gap-2"><i class="ph ph-download-simple"></i> Download Backup JSON</button>
                            </div>
                        </div>
                        
                        <div id="settings-system" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold dark:text-white">System Preferences</h3>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Cache settings and performance tuning.</p>
                                <div class="mt-4"><button onclick="clearSystemCache()" class="border border-red-500 text-red-500 px-4 py-2 rounded hover:bg-red-50 dark:hover:bg-red-900/20">Clear System Cache</button></div>
                            </div>
                        </div>
                        
                        <div id="settings-audit" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold dark:text-white">Audit Logs</h3>
                            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                                <table class="w-full text-left text-sm"><thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-100 dark:border-gray-700"><tr><th class="px-4 py-3 dark:text-gray-300">Action</th><th class="px-4 py-3 dark:text-gray-300">User</th><th class="px-4 py-3 dark:text-gray-300">Time</th></tr></thead>
                                    <tbody id="audit-log-body" class="divide-y divide-gray-50 dark:divide-gray-700">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="settings-advanced" class="settings-content hidden space-y-6">
                            <h3 class="text-xl font-bold dark:text-white">Advanced</h3>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Developer mode and debugging tools.</p>
                                <div class="flex items-center justify-between"><span class="text-gray-700 dark:text-gray-300 font-medium">Enable Debug Mode</span> <input type="checkbox" id="toggle-debug" class="toggle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm" onclick="toggleModal('productModal', false)"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col animate-fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 z-10">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white" id="productModalTitle">Add New Product</h3>
                <button onclick="toggleModal('productModal', false)" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex border-b border-gray-100 dark:border-gray-700 px-6 space-x-6">
                <button type="button" class="tab-btn active py-3 text-sm focus:outline-none" onclick="switchTab('tab-general')">General</button>
                <button type="button" class="tab-btn py-3 text-sm focus:outline-none" onclick="switchTab('tab-details')">Details & Media</button>
                <button type="button" class="tab-btn py-3 text-sm focus:outline-none" onclick="switchTab('tab-shipping')">Shipping & Policy</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-gray-900">
                <form id="productForm" class="space-y-6">
                    <input type="hidden" id="p-id">
                    <div id="tab-general" class="tab-content space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Product Title</label><input type="text" id="p-name" placeholder="e.g. Wireless Headphones" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white" required></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Price (৳)</label><input type="number" id="p-price" placeholder="0.00" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white" required></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Discount Price (Optional)</label><input type="number" id="p-discount" placeholder="0.00" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label><select id="p-category" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg outline-none bg-white dark:bg-gray-800 dark:text-white"><option value="Electronics">Electronics</option><option value="Fashion">Fashion</option><option value="Tools">Tools</option><option value="Beauty">Beauty</option></select></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Stock Quantity</label><input type="number" id="p-stock" placeholder="e.g. 50" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Delivery Fee (৳)</label><input type="number" id="p-delivery-fee" placeholder="0.00" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tax (%)</label><input type="number" id="p-tax" placeholder="0.00" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></div>
                            
                            <!-- NEW STATUS FIELD -->
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label><select id="p-status" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg outline-none bg-white dark:bg-gray-800 dark:text-white"><option value="Active">Active</option><option value="Draft">Draft</option><option value="Out of Stock">Out of Stock</option></select></div>
                        </div>
                    </div>
                    <!-- DETAILS TAB (Updated with AI Button) -->
                    <div id="tab-details" class="tab-content hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Gallery</label>
                            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:bg-gray-100 dark:hover:bg-gray-800 transition cursor-pointer relative">
                                <input type="file" id="p-images" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleImageUpload(this)">
                                <i class="ph ph-image text-3xl text-gray-400 mb-2"></i>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Click to upload multiple images (JPG/PNG). You can append or replace existing images below.</p>
                            </div>
                            <div class="flex items-center gap-2 mt-2 text-sm">
                                <input type="checkbox" id="p-replace-images" class="w-4 h-4">
                                <label for="p-replace-images" class="text-xs text-gray-500 dark:text-gray-400">Replace existing images on upload</label>
                            </div>
                            <div id="image-previews" class="flex gap-2 mt-4 overflow-x-auto min-h-[80px] items-center"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                                <button type="button" onclick="generateProductDescription()" id="btn-generate-desc" class="text-xs flex items-center gap-1 text-brand-red font-bold hover:bg-red-50 dark:hover:bg-red-900/20 px-2 py-1 rounded transition-colors">
                                    <i class="ph-fill ph-sparkle"></i> ✨ AI Generate
                                </button>
                            </div>
                            <textarea id="p-desc" rows="4" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white" placeholder="Enter description or use AI to generate..."></textarea>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Specifications</label><textarea id="p-specs" rows="3" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></textarea></div>
                    </div>
                    <div id="tab-shipping" class="tab-content hidden space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shipping & Delivery Info</label><textarea id="p-shipping" rows="2" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Return & Refund Policy</label><textarea id="p-return" rows="2" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">FAQs (Optional)</label><textarea id="p-faqs" rows="2" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Related Product IDs</label><input type="text" id="p-related" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-800 dark:text-white"></div>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 flex justify-end gap-3">
                <button type="button" onclick="toggleModal('productModal', false)" class="px-6 py-2 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Cancel</button>
                <button type="button" onclick="submitProductForm()" class="px-6 py-2 bg-brand-red text-white font-bold rounded-lg hover:bg-red-700 shadow-md transition-colors">Save Product</button>
            </div>
        </div>
    </div>
    
    <div id="websiteModal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm" onclick="toggleModal('websiteModal', false)"></div><div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-96 animate-fade-in"><h3 class="text-lg font-bold mb-4 dark:text-white">Add Website</h3><form id="websiteForm" class="space-y-4"><input type="text" id="w-name" placeholder="Name" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" required><input type="url" id="w-url" placeholder="URL" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" required><select id="w-status" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="Active">Active</option><option value="Inactive">Inactive</option></select><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="toggleModal('websiteModal', false)" class="px-4 py-2 text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button><button type="submit" class="px-4 py-2 bg-brand-red text-white rounded-lg">Save</button></div></form></div></div>
    
    <!-- USER MODAL (Shared for Customers & Staff) -->
    <div id="userModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm" onclick="toggleModal('userModal', false)"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-96 animate-fade-in">
            <h3 class="text-lg font-bold mb-4 dark:text-white" id="userModalTitle">Add New Customer</h3>
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="u-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                    <input type="text" id="u-name" placeholder="John Doe" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                    <input type="email" id="u-email" placeholder="john@example.com" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="u-password" placeholder="Leave blank to keep current" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-brand-red outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Role</label>
                    <select id="u-role" class="w-full px-4 py-2 border rounded-lg outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                        <option value="Super Admin">Super Admin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                    <select id="u-status" class="w-full px-4 py-2 border rounded-lg outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="Active">Active</option>
                        <option value="Blocked">Blocked</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="toggleModal('userModal', false)" class="px-4 py-2 text-gray-500 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-brand-red text-white rounded-lg hover:bg-red-700">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-blur-sm" onclick="toggleModal('orderDetailsModal', false)"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col animate-fade-in">
            <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white">Order Details</h3>
                <button onclick="toggleModal('orderDetailsModal', false)" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 bg-gray-50 dark:bg-gray-900 space-y-8">
                <!-- Order Header -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Order ID</p>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="modal-order-id">-</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Order Date</p>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="modal-order-date">-</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Order Status</p>
                        <p class="text-lg font-bold" id="modal-order-status">-</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Total Amount</p>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="modal-order-total">৳0</p>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                        <i class="ph ph-user text-brand-red"></i> Customer Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Full Name</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-cust-name">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Email Address</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-cust-email">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Phone Number</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-cust-phone">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Customer ID</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-cust-id">-</p>
                        </div>
                    </div>
                </div>

                <!-- Billing Address -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                        <i class="ph ph-map-pin text-brand-red"></i> Billing Address
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Street Address</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-addr-street">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">City</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-addr-city">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Postal Code</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-addr-postal">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Country</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-addr-country">-</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                        <i class="ph ph-credit-card text-brand-red"></i> Payment Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Payment Method</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-payment-method">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Payment Status</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-payment-status">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Payment Date</p>
                            <p class="text-gray-900 dark:text-white font-medium" id="modal-payment-date">-</p>
                        </div>
                    </div>
                    
                    <!-- Bank Payment Details (if applicable) -->
                    <div id="modal-bank-details" class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700 hidden">
                        <p class="text-sm font-semibold text-gray-800 dark:text-white mb-3">Bank Transfer Details</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Bank Name</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-bank-name">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Account Number</p>
                                <p class="text-gray-900 dark:text-white font-medium font-mono" id="modal-bank-account">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Transaction Reference</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-bank-ref">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Document Type</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-bank-doctype">-</p>
                            </div>
                        </div>
                        
                        <!-- Bank Document Preview -->
                        <div id="modal-bank-doc" class="mt-4 hidden">
                            <p class="text-sm font-semibold text-gray-800 dark:text-white mb-2">Payment Document</p>
                            <img id="modal-bank-doc-img" src="" alt="Bank Document" class="w-full h-auto rounded-lg border border-gray-200 dark:border-gray-600 max-h-96 object-contain">
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-100 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                        <i class="ph ph-shopping-cart text-brand-red"></i> Order Items
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                                <tr>
                                    <th class="px-4 py-3 font-semibold text-gray-700 dark:text-gray-300">Product</th>
                                    <th class="px-4 py-3 font-semibold text-gray-700 dark:text-gray-300">Quantity</th>
                                    <th class="px-4 py-3 font-semibold text-gray-700 dark:text-gray-300">Price</th>
                                    <th class="px-4 py-3 font-semibold text-gray-700 dark:text-gray-300 text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="modal-order-items" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">No items</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 p-6 rounded-lg border border-blue-200 dark:border-blue-800">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Order Summary</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">Subtotal</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="modal-subtotal">৳0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">Shipping Cost</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="modal-shipping">৳0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700 dark:text-gray-300">Tax</span>
                            <span class="font-semibold text-gray-900 dark:text-white" id="modal-tax">৳0</span>
                        </div>
                        <div class="border-t border-blue-300 dark:border-blue-700 pt-3 flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-900 dark:text-white">Total</span>
                            <span class="text-2xl font-bold text-brand-red" id="modal-total-final">৳0</span>
                        </div>
                    </div>
                </div>

                <!-- Delivery & Additional Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-100 dark:border-gray-700">
                        <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                            <i class="ph ph-truck text-brand-red"></i> Delivery Information
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Delivery Type</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-delivery-type">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Estimated Delivery</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-delivery-date">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Tracking Number</p>
                                <p class="text-gray-900 dark:text-white font-medium font-mono" id="modal-tracking-number">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg border border-gray-100 dark:border-gray-700">
                        <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                            <i class="ph ph-info text-brand-red"></i> Additional Information
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Order Placed</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-order-placed">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Last Updated</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-last-updated">-</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">Notes</p>
                                <p class="text-gray-900 dark:text-white font-medium" id="modal-notes">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-6 border-t border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 flex justify-end gap-3">
                <button type="button" onclick="toggleModal('orderDetailsModal', false)" class="px-6 py-2 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">Close</button>
                <button type="button" onclick="printOrder()" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i class="ph ph-printer"></i> Print
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP & AUTH ---
        let adminCredentials = JSON.parse(localStorage.getItem('admin_credentials')) || { username: 'admin', password: 'Ilovemoney' };
        const apiKey = ""; 

        let products = JSON.parse(localStorage.getItem('admin_products') || '[]');
        let websites = JSON.parse(localStorage.getItem('admin_websites') || '[]');
        let orders = JSON.parse(localStorage.getItem('admin_orders') || '[]');
        let users = JSON.parse(localStorage.getItem('admin_users') || '[]');
        let reviews = JSON.parse(localStorage.getItem('site_reviews') || '[]');
        let banners = JSON.parse(localStorage.getItem('admin_banners') || '[]');
        let financeData = JSON.parse(localStorage.getItem('admin_finance') || '{"added":0, "withdrawn":0, "transactions":[]}');
        let generalSettings = JSON.parse(localStorage.getItem('admin_settings_general') || '{"siteName":"NOKLITY", "email":"support@noklity.com", "currency":"BDT", "logoUrl":""}');
        let apiSettings = JSON.parse(localStorage.getItem('admin_api_settings')) || { apiKey: 'nok_live_' + Math.random().toString(36).substr(2, 9), webhooks: [] };
        let notifications = JSON.parse(localStorage.getItem('admin_notifications')) || [];
        let auditLogs = JSON.parse(localStorage.getItem('admin_audit_logs')) || [];
        let notifSettings = JSON.parse(localStorage.getItem('admin_notif_settings')) || {email: true, stock: true, user: false};
        let paymentSettings = JSON.parse(localStorage.getItem('admin_payment_settings')) || {pub: '', sec: ''};
        let systemSettings = JSON.parse(localStorage.getItem('admin_system_settings') || '{"twoFactor":false, "forcePassChange":false, "debugMode":false}');

        let tempImages = [];
        let tempFeaturedIndex = 0; // index of the featured image in tempImages
        let _dragSrcIndex = null;
        let tempLogoUrl = "";
        let selectedUsers = [];
        let storeOpen = localStorage.getItem('admin_store_open') === 'true';

        // --- THEME ---
        function initTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                const icon = document.getElementById('theme-icon');
                if(icon) icon.classList.replace('ph-moon', 'ph-sun');
            } else {
                document.documentElement.classList.remove('dark');
                const icon = document.getElementById('theme-icon');
                if(icon) icon.classList.replace('ph-sun', 'ph-moon');
            }
        }
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                icon.classList.replace('ph-sun', 'ph-moon');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                icon.classList.replace('ph-moon', 'ph-sun');
            }
        }

        // --- UTILS: TOAST & LOGS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'ph-check-circle' : 'ph-warning-circle';
            const color = type === 'success' ? 'bg-gray-900 text-white dark:bg-white dark:text-gray-900' : 'bg-red-500 text-white';
            
            toast.className = `p-4 rounded-lg shadow-xl flex items-center gap-3 transform transition-all duration-300 toast-enter ${color}`;
            toast.innerHTML = `<i class="ph-fill ${icon} text-lg"></i> <span class="text-sm font-medium">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function logAction(action, user = 'Admin') {
            const log = { action, user, time: new Date().toLocaleString() };
            auditLogs.unshift(log);
            if(auditLogs.length > 50) auditLogs.pop(); // Keep last 50
            localStorage.setItem('admin_audit_logs', JSON.stringify(auditLogs));
            renderAuditLogs();
        }

        function renderAuditLogs() {
            const tbody = document.getElementById('audit-log-body');
            if(tbody) {
                tbody.innerHTML = auditLogs.map(l => `
                    <tr>
                        <td class="px-4 py-3 text-gray-800 dark:text-gray-300 font-medium">${l.action}</td>
                        <td class="px-4 py-3 text-gray-500 dark:text-gray-400">${l.user}</td>
                        <td class="px-4 py-3 text-gray-500 dark:text-gray-400 text-xs">${l.time}</td>
                    </tr>
                `).join('');
            }
        }

        // --- AUTH ---
        function checkAuth() {
            const currentUser = sessionStorage.getItem('isAdminAuthenticated');
            if (currentUser) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                const parts = currentUser.split('|');
                const role = parts[1] || 'Super Admin';
                const name = parts[2] || adminCredentials.username;

                document.getElementById('header-username').innerText = name.charAt(0).toUpperCase() + name.slice(1);
                document.getElementById('header-role').innerText = role;

                ensureOrderData(); 
                initTheme(); 
                initApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                initTheme();
            }
        }
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const inputUser = document.getElementById('username').value;
            const inputPass = document.getElementById('password').value;
            
            if (inputUser === adminCredentials.username && inputPass === adminCredentials.password) {
                sessionStorage.setItem('isAdminAuthenticated', 'true|Super Admin|' + inputUser);
                logAction('Logged in (Root)');
                checkAuth();
                return;
            }
            const staffUser = users.find(u => (u.name === inputUser || u.email === inputUser) && u.password === inputPass && u.role !== 'Customer');
            if (staffUser && staffUser.status === 'Active') {
                sessionStorage.setItem('isAdminAuthenticated', 'true|' + staffUser.role + '|' + staffUser.name);
                logAction(`Logged in (${staffUser.role})`, staffUser.name);
                checkAuth();
            } else { 
                document.getElementById('login-error').innerText = staffUser && staffUser.status === 'Blocked' ? 'Account is blocked.' : 'Invalid credentials.';
                document.getElementById('login-error').classList.remove('hidden'); 
            }
        });
        function logout() { sessionStorage.removeItem('isAdminAuthenticated'); window.location.reload(); }

        // --- APP LOGIC ---
        function ensureOrderData() {
            let changed = false;
            orders = orders.map(o => {
                let u = {...o};
                if (!u.type) { u.type = Math.random() > 0.5 ? 'Delivery' : 'Collection'; changed = true; }
                if (!u.payment) { u.payment = Math.random() > 0.5 ? 'Cash' : 'Paid'; changed = true; }
                if (!u.time) { u.time = (Math.floor(Math.random() * 45) + 5) + ' min'; changed = true; }
                if (!u.status) { u.status = 'Pending'; changed = true; }
                return u;
            });
            if(changed) saveData(false); // Silent save
        }
        
        function showSection(id) {
            ['dashboard', 'products', 'orders', 'websites', 'users', 'finance', 'reviews', 'marketing', 'settings'].forEach(sid => {
                document.getElementById('section-' + sid).classList.add('hidden');
                const nav = document.getElementById('nav-' + sid);
                if(nav) nav.classList.remove('active');
            });
            const section = document.getElementById('section-' + id);
            section.classList.remove('hidden');
            if(id === 'settings') section.classList.add('flex');
            const targetNav = document.getElementById('nav-' + id);
            if(targetNav) targetNav.classList.add('active');
            document.getElementById('page-title').innerText = id.charAt(0).toUpperCase() + id.slice(1);
        }
        
        function switchSettingsTab(tabId) {
            document.querySelectorAll('.settings-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.settings-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // --- SETTINGS LOGIC ---
        function loadSettingsUI() {
            // Notifications
            document.getElementById('notif-email').checked = notifSettings.email;
            document.getElementById('notif-stock').checked = notifSettings.stock;
            document.getElementById('notif-user').checked = notifSettings.user;
            
            // Payment
            document.getElementById('stripe-pub').value = paymentSettings.pub;
            document.getElementById('stripe-sec').value = paymentSettings.sec;
        }
        
        function loadSystemSettings() {
            document.getElementById('toggle-2fa').checked = systemSettings.twoFactor;
            document.getElementById('toggle-force-pass').checked = systemSettings.forcePassChange;
            document.getElementById('toggle-debug').checked = systemSettings.debugMode;
        }

        function saveSystemSettings() {
            systemSettings.twoFactor = document.getElementById('toggle-2fa').checked;
            systemSettings.forcePassChange = document.getElementById('toggle-force-pass').checked;
            systemSettings.debugMode = document.getElementById('toggle-debug').checked;
            localStorage.setItem('admin_system_settings', JSON.stringify(systemSettings));
        }

        function saveNotificationSettings() {
            notifSettings.email = document.getElementById('notif-email').checked;
            notifSettings.stock = document.getElementById('notif-stock').checked;
            notifSettings.user = document.getElementById('notif-user').checked;
            localStorage.setItem('admin_notif_settings', JSON.stringify(notifSettings));
            logAction('Updated Notification Settings');
            showToast('Notification preferences saved');
        }

        function savePaymentSettings() {
            paymentSettings.pub = document.getElementById('stripe-pub').value;
            paymentSettings.sec = document.getElementById('stripe-sec').value;
            localStorage.setItem('admin_payment_settings', JSON.stringify(paymentSettings));
            logAction('Updated Payment Keys');
            showToast('Payment keys securely saved');
        }

        function downloadBackup() {
            const backup = { products, users, orders, websites, reviews, financeData, generalSettings, apiSettings };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "noklity_backup_" + Date.now() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            logAction('Downloaded System Backup');
            showToast('Backup downloaded successfully');
        }

        function exportOrders() {
            if (orders.length === 0) {
                showToast('No orders to export.', 'error');
                return;
            }
            const headers = "ID,Customer,Payment,Time,Type,Status,Total";
            const csvRows = orders.map(o => {
                // Sanitize by wrapping in quotes and escaping existing quotes
                const customer = `"${(o.customer || 'Guest').replace(/"/g, '""')}"`; 
                const values = [o.id, customer, o.payment || 'N/A', o.time || 'N/A', o.type || 'N/A', o.status || 'N/A', o.total || 0];
                return values.join(',');
            });
            
            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...csvRows].join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `noklity_orders_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            link.remove();
            showToast('Orders list exported successfully');
            logAction('Exported orders list');
        }

        function clearSystemCache() {
            if(confirm('This will clear all data and reset the dashboard. Are you sure?')) {
                localStorage.clear();
                window.location.reload();
            }
        }

        // --- DATA MANAGEMENT ---
        function saveData(notify = true) {
            const data = {
                'admin_products': products,
                'admin_websites': websites,
                'admin_orders': orders,
                'admin_finance': financeData,
                'admin_users': users,
                'admin_banners': banners,
                'admin_audit_logs': auditLogs,
                'admin_notifications': notifications,
            };
            try {
                const productsToSave = products.map(p => {
                    const { images, imageUrl, ...rest } = p;
                    return rest;
                });
                localStorage.setItem('admin_products', JSON.stringify(productsToSave));
                localStorage.setItem('admin_websites', JSON.stringify(websites));
                localStorage.setItem('admin_orders', JSON.stringify(orders));
                localStorage.setItem('admin_finance', JSON.stringify(financeData));
                localStorage.setItem('admin_users', JSON.stringify(users));
                localStorage.setItem('admin_banners', JSON.stringify(banners));
                localStorage.setItem('admin_audit_logs', JSON.stringify(auditLogs));
                localStorage.setItem('admin_notifications', JSON.stringify(notifications));

                if(notify) initApp(); // Refresh UI
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    // First attempt failed, try to free up space and retry
                    console.warn("QuotaExceededError caught. Clearing logs and notifications to free space.");
                    localStorage.removeItem('admin_audit_logs');
                    localStorage.removeItem('admin_notifications');
                    auditLogs = [];
                    notifications = [];
                    
                    try {
                        // Retry saving essential data
                        const productsToSave = products.map(p => {
                            const { images, imageUrl, ...rest } = p;
                            return rest;
                        });
                        localStorage.setItem('admin_products', JSON.stringify(productsToSave));
                        localStorage.setItem('admin_websites', JSON.stringify(websites));
                        localStorage.setItem('admin_orders', JSON.stringify(orders));
                        localStorage.setItem('admin_finance', JSON.stringify(financeData));
                        localStorage.setItem('admin_users', JSON.stringify(users));
                        localStorage.setItem('admin_banners', JSON.stringify(banners));
                        showToast('Storage was full. Cleared logs to save data.', 'success');
                        if(notify) initApp();
                    } catch (e2) {
                        // If it fails again, then we are truly out of space.
                        console.error("Still out of space after clearing logs.", e2);
                        showToast('Storage limit still exceeded after clearing logs!', 'error');
                    }
                }
            }
        }

        // --- MARKETING BANNERS ---
        document.getElementById('bannerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const url = document.getElementById('banner-url').value;
            const link = document.getElementById('banner-link').value;
            if(url) {
                banners.push({ id: Date.now(), url, link });
                saveData();
                renderBanners();
                e.target.reset();
                showToast('Banner added');
            }
        });

        function renderBanners() {
            const list = document.getElementById('banner-list');
            if(list) {
                list.innerHTML = banners.map(b => `
                    <div class="flex items-center gap-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                        <img src="${b.url}" class="w-16 h-10 object-cover rounded border border-gray-200 dark:border-gray-600">
                        <div class="flex-1 truncate text-xs text-gray-500 dark:text-gray-400">${b.link || 'No link'}</div>
                        <button onclick="deleteBanner(${b.id})" class="text-red-500 hover:text-red-700"><i class="ph ph-trash"></i></button>
                    </div>
                `).join('');
            }
        }
        function deleteBanner(id) {
            if(confirm('Delete banner?')) {
                banners = banners.filter(b => b.id !== id);
                saveData();
                renderBanners();
                showToast('Banner deleted');
            }
        }

        // --- NOTIFICATIONS ---
        function renderNotifications() {
            const notifList = document.getElementById('notification-list');
            const badge = document.getElementById('notif-badge');
            const emptyMsg = document.getElementById('empty-notif');
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if(unreadCount > 0) { badge.classList.remove('hidden'); } 
            else { badge.classList.add('hidden'); }

            if(notifications.length === 0) {
                notifList.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                notifList.innerHTML = notifications.map(n => `
                    <div class="p-4 border-b border-gray-50 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition flex gap-3 ${!n.read ? 'bg-blue-50/50 dark:bg-blue-900/10' : ''}">
                        <div class="w-2 h-2 mt-2 rounded-full ${!n.read ? 'bg-brand-red' : 'bg-gray-300 dark:bg-gray-600'} flex-shrink-0"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-800 dark:text-gray-200 font-medium">${n.message}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${n.time}</p>
                        </div>
                    </div>
                `).join('');
            }
        }
        function toggleNotificationMenu() {
            const menu = document.getElementById('notification-menu');
            menu.classList.toggle('hidden');
        }
        function clearNotifications() {
            notifications = [];
            localStorage.setItem('admin_notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        // --- INIT ---
        document.getElementById('freeDeliveryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const expiryDate = document.getElementById('offer-expiry-date').value;
            if (expiryDate) {
                const offer = { expiryDate };
                localStorage.setItem('freeDeliveryOffer', JSON.stringify(offer));
                renderActiveOffer();
                showToast('Free delivery offer saved');
                logAction('Saved free delivery offer');
            }
        });

        function renderActiveOffer() {
            const offerContainer = document.getElementById('active-offer-container');
            const offer = JSON.parse(localStorage.getItem('freeDeliveryOffer') || 'null');
            if (offer && new Date(offer.expiryDate) > new Date()) {
                offerContainer.innerHTML = `
                    <div class="flex items-center justify-between bg-green-100 dark:bg-green-900/30 p-4 rounded-lg">
                        <p class="text-sm text-green-700 dark:text-green-300">Free delivery offer is active until ${new Date(offer.expiryDate).toLocaleDateString()}</p>
                        <button onclick="deleteFreeDeliveryOffer()" class="text-red-500 hover:text-red-700"><i class="ph ph-trash"></i></button>
                    </div>
                `;
            } else {
                offerContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No active free delivery offer.</p>';
            }
        }

        function deleteFreeDeliveryOffer() {
            if (confirm('Delete the free delivery offer?')) {
                localStorage.removeItem('freeDeliveryOffer');
                renderActiveOffer();
                showToast('Free delivery offer deleted');
                logAction('Deleted free delivery offer');
            }
        }

        function initApp() { 
            renderTables(); 
            renderStats(); 
            renderFinance(); 
            loadGeneralSettings(); 
            updateSidebarLogo(); 
            renderStoreToggle(); 
            renderApiSettings(); 
            renderNotifications();
            renderBanners();
            loadSettingsUI();
            renderAuditLogs();
            loadSystemSettings();
            renderActiveOffer();
        }

        // --- HELPER FUNCTIONS ---

        function renderStats() {
            document.getElementById('dash-products').innerText = products.length;
            document.getElementById('dash-websites').innerText = websites.length;
            document.getElementById('dash-orders').innerText = orders.length;
            // Fix for undefined total
            const totalRevenue = orders.reduce((s,o)=>s+(Number(o.total)||0),0);
            document.getElementById('dash-sales').innerText = '৳' + totalRevenue.toLocaleString();
        }

        function renderFinance() {
            let rev = orders.filter(o => ['Delivery', 'Completed', 'Customer Review Submission'].includes(o.status)).reduce((s,o)=>s+(Number(o.total)||0),0);
            let bal = rev + (financeData.added || 0) - (financeData.withdrawn || 0);
            document.getElementById('fin-balance').innerText = '৳' + bal.toLocaleString();
            document.getElementById('fin-withdrawn').innerText = '৳' + (financeData.withdrawn || 0).toLocaleString();
            renderFinanceHistory();
        }

        function renderFinanceHistory() {
            const tbody = document.getElementById('finance-list-body');
            if (!tbody) return;
            tbody.innerHTML = (financeData.transactions || []).map(t => `<tr class="border-b border-gray-50 dark:border-gray-700"><td class="px-6 py-4 text-sm font-medium ${t.type === 'Withdrawal' ? 'text-red-500' : 'text-green-500'}">${t.type}</td><td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${new Date(t.date).toLocaleDateString()}</td><td class="px-6 py-4 text-sm font-bold">৳${t.amount.toLocaleString()}</td></tr>`).join('');
            // Pending calculation
            let pending = orders.filter(o => !['Delivery', 'Completed', 'Cancelled', 'Customer Review Submission'].includes(o.status)).reduce((s,o)=>s+(Number(o.total)||0),0);
            document.getElementById('fin-pending').innerText = '৳' + pending.toLocaleString();
        }

        // --- Toggle Store Logic ---
        function toggleStoreStatus() {
            storeOpen = !storeOpen;
            localStorage.setItem('admin_store_open', storeOpen);
            renderStoreToggle();
            showToast(storeOpen ? 'Store is now OPEN' : 'Store is now CLOSED');
        }
        
        function renderStoreToggle() {
            const container = document.getElementById('store-toggle-btn');
            const dot = document.getElementById('store-toggle-dot');
            if(container && dot) {
                if(storeOpen) {
                    container.classList.remove('bg-gray-300');
                    container.classList.add('bg-green-500');
                    dot.classList.add('translate-x-5'); 
                } else {
                    container.classList.add('bg-gray-300');
                    container.classList.remove('bg-green-500');
                    dot.classList.remove('translate-x-5');
                }
            }
        }
        
        // --- PRESERVE PREVIOUS UTILS ---
        // Compress image file to a JPEG/PNG dataURL with max width/height
        function compressImageFile(file, maxDim = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => { img.src = e.target.result; };
                reader.onerror = reject;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let { width, height } = img;
                    if (width > maxDim || height > maxDim) {
                        const scale = Math.min(maxDim / width, maxDim / height);
                        width = Math.round(width * scale);
                        height = Math.round(height * scale);
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const type = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                    const dataUrl = canvas.toDataURL(type, quality);
                    resolve(dataUrl);
                };
                img.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleImageUpload(input) {
            if (!input || !input.files) return;
            const replace = document.getElementById('p-replace-images') && document.getElementById('p-replace-images').checked;
            if (replace) { tempImages = []; tempFeaturedIndex = 0; }

            for (const file of Array.from(input.files)) {
                if (!file.type.startsWith('image/')) continue;
                try {
                    const dataUrl = await compressImageFile(file, 800, 0.7);
                    tempImages.push(dataUrl);
                    renderImagePreviews();
                } catch (err) {
                    console.warn('Image compression failed', err);
                }
            }
            input.value = '';
        }

        function renderImagePreviews() {
            const container = document.getElementById('image-previews');
            if (!container) return;
            if (!tempImages || tempImages.length === 0) {
                container.innerHTML = `<div class="text-xs text-gray-400 dark:text-gray-500">No images uploaded yet. Use the upload area above to add product images.</div>`;
                return;
            }

            container.innerHTML = tempImages.map((src, idx) => `
                <div draggable="true" ondragstart="dragStart(event, ${idx})" ondragover="dragOver(event, ${idx})" ondrop="dropImage(event, ${idx})" class="relative w-28 h-20 flex-shrink-0 group rounded overflow-hidden border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800">
                    <img src="${src}" class="w-full h-full object-cover">
                    <div class="absolute left-1 top-1 bg-white/80 dark:bg-black/60 px-1 py-0.5 rounded text-xs">
                        <button onclick="setFeatured(event, ${idx})" class="text-yellow-600 dark:text-yellow-300" title="Set as featured"><i class="ph ph-star"></i></button>
                    </div>
                    ${idx === tempFeaturedIndex ? '<div class="absolute left-1 bottom-1 bg-brand-red text-white text-xs px-1 rounded">Featured</div>' : ''}
                    <button onclick="removeImage(${idx})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">×</button>
                    <div class="absolute right-1 bottom-1 text-[10px] text-gray-700 dark:text-gray-300 bg-white/70 dark:bg-black/50 px-1 rounded">${idx + 1}</div>
                </div>
            `).join('');
        }

        function removeImage(idx) {
            tempImages.splice(idx, 1);
            if (tempFeaturedIndex >= tempImages.length) tempFeaturedIndex = Math.max(0, tempImages.length - 1);
            renderImagePreviews();
        }

        function setFeatured(e, idx) {
            e.stopPropagation();
            tempFeaturedIndex = idx;
            renderImagePreviews();
        }

        function dragStart(e, idx) { _dragSrcIndex = idx; }
        function dragOver(e) { e.preventDefault(); }
        function dropImage(e, targetIdx) {
            e.preventDefault();
            if (_dragSrcIndex === null || _dragSrcIndex === undefined) return;
            const src = tempImages[_dragSrcIndex];
            tempImages.splice(_dragSrcIndex, 1);
            tempImages.splice(targetIdx, 0, src);
            // update featured index if necessary
            if (_dragSrcIndex === tempFeaturedIndex) tempFeaturedIndex = targetIdx;
            else if (_dragSrcIndex < tempFeaturedIndex && targetIdx >= tempFeaturedIndex) tempFeaturedIndex--;
            else if (_dragSrcIndex > tempFeaturedIndex && targetIdx <= tempFeaturedIndex) tempFeaturedIndex++;
            _dragSrcIndex = null;
            renderImagePreviews();
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempLogoUrl = e.target.result;
                    document.getElementById('site-logo-preview').src = tempLogoUrl;
                    document.getElementById('site-logo-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function updateSidebarLogo() {
            const container = document.getElementById('sidebar-logo-container');
            const defaultSVG = `<svg viewBox="0 0 100 100" fill="none" class="w-full h-full"><path d="M20 20 V80 L50 50 L20 20 Z" fill="#D9232D"/><path d="M80 80 V20 L50 50 L80 80 Z" fill="#111111" class="dark:fill-white"/></svg>`;
            if (generalSettings.logoUrl) {
                container.innerHTML = `<img src="${generalSettings.logoUrl}" class="w-full h-full object-contain">`;
            } else {
                container.innerHTML = defaultSVG;
            }
            document.getElementById('sidebar-site-name').innerText = generalSettings.siteName;
        }
        function loadGeneralSettings() {
            document.getElementById('site-name').value = generalSettings.siteName;
            document.getElementById('site-email').value = generalSettings.email;
            document.getElementById('site-currency').value = generalSettings.currency;
            if(generalSettings.logoUrl) {
                 document.getElementById('site-logo-preview').src = generalSettings.logoUrl;
                 document.getElementById('site-logo-preview').classList.remove('hidden');
            }
        }
        document.getElementById('generalSettingsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            generalSettings.siteName = document.getElementById('site-name').value;
            generalSettings.email = document.getElementById('site-email').value;
            generalSettings.currency = document.getElementById('site-currency').value;
            if (tempLogoUrl) generalSettings.logoUrl = tempLogoUrl;
            localStorage.setItem('admin_settings_general', JSON.stringify(generalSettings));
            updateSidebarLogo();
            showToast('General Settings Saved');
            logAction('Updated General Settings');
        });

        document.getElementById('changeCredentialsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newUsername = document.getElementById('new-username').value;
            const newPassword = document.getElementById('new-password').value;

            if (currentPassword !== adminCredentials.password) {
                showToast('Current password is incorrect', 'error');
                return;
            }

            if (newUsername) adminCredentials.username = newUsername;
            if (newPassword) adminCredentials.password = newPassword;

            localStorage.setItem('admin_credentials', JSON.stringify(adminCredentials));
            showToast('Admin credentials updated successfully');
            logAction('Updated root admin credentials');
            e.target.reset();
        });

        document.getElementById('websiteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('w-name').value;
            const url = document.getElementById('w-url').value;
            const status = document.getElementById('w-status').value;
            if (name && url) {
                websites.push({ id: Date.now(), name, url, status });
                saveData();
                toggleModal('websiteModal', false);
                showToast('Website added successfully');
                logAction(`Added website: ${name}`);
                e.target.reset();
            }
        });

        document.getElementById('withdrawForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = Number(document.getElementById('withdraw-amount').value);
            if (amount > 0) {
                financeData.withdrawn = (financeData.withdrawn || 0) + amount;
                financeData.transactions.unshift({ type: 'Withdrawal', amount, date: new Date() });
                saveData();
                renderFinance();
                showToast('Withdrawal successful');
                logAction(`Withdrew ৳${amount}`);
                e.target.reset();
            }
        });

        document.getElementById('addBalanceForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = Number(document.getElementById('add-amount').value);
            if (amount > 0) {
                financeData.added = (financeData.added || 0) + amount;
                financeData.transactions.unshift({ type: 'Added Funds', amount, date: new Date() });
                saveData();
                renderFinance();
                showToast('Funds added successfully');
                logAction(`Added ৳${amount}`);
                e.target.reset();
            }
        });

        function openProductModal(productId) {
            tempImages = [];
            tempFeaturedIndex = 0;
            const modalTitle = document.getElementById('productModalTitle');
            if (productId) {
                const product = products.find(p => p.id == productId);
                if (product) {
                    modalTitle.innerText = 'Edit Product';
                    document.getElementById('p-id').value = product.id;
                    document.getElementById('p-name').value = product.name;
                    document.getElementById('p-desc').value = product.description || '';
                    document.getElementById('p-specs').value = product.specifications || '';
                    document.getElementById('p-price').value = product.price;
                    document.getElementById('p-discount').value = product.discountPrice || '';
                    document.getElementById('p-category').value = product.category;
                    document.getElementById('p-stock').value = product.stock || 0;
                    document.getElementById('p-status').value = product.status || 'Active';
                    document.getElementById('p-delivery-fee').value = product.deliveryFee || '';
                    document.getElementById('p-tax').value = product.tax || '';
                    document.getElementById('p-shipping').value = product.shippingInfo || '';
                    document.getElementById('p-return').value = product.returnPolicy || '';
                    document.getElementById('p-faqs').value = product.faqs || '';
                    document.getElementById('p-related').value = (product.relatedProducts || []).join(',');

                    // Load images
                    tempImages = [...(product.images || (product.imageUrl ? [product.imageUrl] : []))];
                    tempFeaturedIndex = product.featuredImageIndex || 0;
                    
                    renderImagePreviews();
                }
            } else {
                modalTitle.innerText = 'Add New Product';
                document.getElementById('productForm').reset();
                document.getElementById('p-id').value = '';
                renderImagePreviews();
            }
            switchTab('tab-general');
            toggleModal('productModal', true);
        }

        function submitProductForm() {
            const id = document.getElementById('p-id').value;
            const name = document.getElementById('p-name').value;
            const desc = document.getElementById('p-desc').value;
            const price = document.getElementById('p-price').value;
            const category = document.getElementById('p-category').value;
            const stock = document.getElementById('p-stock').value;
            const status = document.getElementById('p-status').value;
            const deliveryFee = document.getElementById('p-delivery-fee').value;
            const tax = document.getElementById('p-tax').value;

            if (!name || !price || !category) {
                showToast('Product Title, Price, and Category are required.', 'error');
                return;
            }

            const productData = {
                name: name,
                description: desc,
                price: Number(price),
                category: category,
                stock: Number(stock),
                status: status,
                deliveryFee: Number(deliveryFee),
                tax: Number(tax),
                imageUrl: tempImages.length > 0 ? (tempImages[tempFeaturedIndex] || tempImages[0]) : (id ? products.find(p => p.id == id).imageUrl : 'https://via.placeholder.com/300'),
                images: tempImages.length > 0 ? tempImages : (id ? products.find(p => p.id == id).images : [])
            };

            if (id) {
                const index = products.findIndex(p => p.id == id);
                if (index !== -1) {
                    products[index] = { ...products[index], ...productData };
                    logAction(`Updated product: ${name}`);
                }
            } else {
                products.unshift({ id: Date.now(), ...productData });
                logAction(`Added new product: ${name}`);
            }

            saveData();
            toggleModal('productModal', false);
            showToast(`Product ${id ? 'updated' : 'saved'} successfully`);
        }

        document.getElementById('userForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('u-id').value;
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const password = document.getElementById('u-password').value;
            const role = document.getElementById('u-role').value;
            const status = document.getElementById('u-status').value;
            if (!name || !email) { showToast('Name and email are required', 'error'); return; }
            if (id) { const i = users.findIndex(u => u.id == id); if (i !== -1) { Object.assign(users[i], {name, email, role, status}); if(password) users[i].password = password; logAction(`Updated user: ${name}`); }
            } else { if (!password) { showToast('Password is required for new users', 'error'); return; } users.push({ id: Date.now(), name, email, password, role, status, joined: new Date().toLocaleDateString() }); logAction(`Added new user: ${name}`); }
            saveData(); toggleModal('userModal', false); showToast('User saved successfully');
        });

        document.getElementById('toggle-2fa').addEventListener('change', () => { saveSystemSettings(); showToast('Security setting updated'); });
        document.getElementById('toggle-force-pass').addEventListener('change', () => { saveSystemSettings(); showToast('Security setting updated'); });
        document.getElementById('toggle-debug').addEventListener('change', () => { saveSystemSettings(); showToast('Advanced setting updated'); });


        // --- KEEP CHARTS ---
        function initCharts() {
            const ctx1 = document.getElementById('revenueChart');
            if(ctx1) { new Chart(ctx1, { type: 'line', data: { labels: ['M','T','W','T','F','S','S'], datasets: [{ label: 'Revenue', data: [1200, 1900, 1500, 2200, 1800, 2800, 2500], borderColor: '#D9232D', backgroundColor: 'rgba(217, 35, 45, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { display: false } } } }); }
            const ctx2 = document.getElementById('targetChart');
            if(ctx2) { new Chart(ctx2, { type: 'doughnut', data: { labels: ['Done', 'Left'], datasets: [{ data: [85, 15], backgroundColor: ['#D9232D', '#F3F4F6'], borderWidth: 0, circumference: 180, rotation: 270, cutout: '85%' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } }); }
        }

        // Modal helper: show/hide modal by id
        function toggleModal(modalId, show) {
            const el = document.getElementById(modalId);
            if (!el) return;
            if (show) {
                el.classList.remove('hidden');
                // trap focus to modal
                const focusable = el.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (focusable) focusable.focus();
            } else {
                el.classList.add('hidden');
            }
        }

        // Tab helper for modals: switch visible tab content and active tab button
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
            const tab = document.getElementById(tabId);
            if (tab) tab.classList.remove('hidden');
            // find button with matching onclick attribute and mark active
            const selector = `.tab-btn[onclick="switchTab('${tabId}')"]`;
            const btn = document.querySelector(selector);
            if (btn) btn.classList.add('active');
        }

        function toggleOrderMenu(event, orderId) {
            event.stopPropagation();
            const menu = document.getElementById(`order-menu-${orderId}`);
            
            // Close all other menus
            document.querySelectorAll('[id^="order-menu-"]').forEach(m => {
                if (m.id !== `order-menu-${orderId}`) {
                    m.classList.add('hidden');
                }
            });
            
            // Toggle current menu
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }

        window.addEventListener('click', (e) => {
            if (!e.target.closest('[id^="order-menu-"]') && !e.target.closest('button[onclick*="toggleOrderMenu"]')) {
                document.querySelectorAll('[id^="order-menu-"]').forEach(el => el.classList.add('hidden'));
            }
            const notifMenu = document.getElementById('notification-menu');
            const notifBtn = document.querySelector('button[onclick="toggleNotificationMenu()"]');
            if (notifMenu && !notifMenu.classList.contains('hidden') && !notifMenu.contains(e.target) && !notifBtn.contains(e.target)) {
                notifMenu.classList.add('hidden');
            }
        });

        // --- RENDER TABLES ---
        function renderTables() {
            document.getElementById('product-list-body').innerHTML = products.map(p => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700">
                    <td class="px-6 py-4 flex items-center">
                        <img src="${p.imageUrl || 'https://via.placeholder.com/150'}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150'" class="w-10 h-10 rounded border mr-3 object-cover">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">${p.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">ID: ${p.id}</p>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">${p.category}</td>
                    <td class="px-6 py-4 font-bold text-gray-900 dark:text-white">৳${p.price}</td>
                    <td class="px-6 py-4 text-sm dark:text-gray-300">${p.stock || 0} in stock</td>
                    <td class="px-6 py-4 text-sm"><span class="px-2 py-1 rounded text-xs ${p.status === 'Active' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-300'}">${p.status || 'Active'}</span></td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="openProductModal(${JSON.stringify(p.id)})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-3 text-sm font-medium">Edit</button>
                        <button onclick="deleteItem('product', ${JSON.stringify(p.id)})" class="text-red-500 hover:text-red-700 dark:hover:text-red-400 text-sm">Delete</button>
                    </td>
                </tr>`).join('');
            renderUsers();
            
            const staffList = users.filter(u => u.role !== 'Customer');
            document.getElementById('staff-list-body').innerHTML = staffList.map(u => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700"><td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${u.name}<br><span class="text-xs text-gray-500 dark:text-gray-400">${u.email}</span></td><td class="px-6 py-4"><span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs">${u.role}</span></td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs ${u.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${u.status}</span></td><td class="px-6 py-4 text-right"><button onclick="openUserModal(${u.id}, true)" class="text-blue-600 text-xs mr-2">Edit</button><button onclick="deleteItem('user', ${u.id})" class="text-red-600 text-xs">Delete</button></td></tr>`).join('');

            const orderBody = document.getElementById('order-list-body');
            orderBody.innerHTML = orders.map(o => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 dark:border-gray-700">
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">
                        <button onclick="viewOrderDetails('${o.id}')" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold cursor-pointer">
                            #${o.id}
                        </button>
                    </td>
                    <td class="px-6 py-4 text-gray-500 dark:text-gray-300">${o.customer || 'Guest'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">${o.payment || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">${o.time || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-300">${o.type || 'Delivery'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-200">${o.status}</span></td>
                    <td class="px-6 py-4 font-bold text-right">৳${o.total}</td>
                    <td class="px-6 py-4 text-right relative">
                        <button onclick="toggleOrderMenu(event, '${o.id}')" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white" title="More options">
                            <i class="ph ph-dots-three-vertical text-lg"></i>
                        </button>
                        <div id="order-menu-${o.id}" class="absolute right-0 top-8 bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-100 dark:border-gray-700 hidden z-20 w-56 py-1">
                            <button onclick="viewOrderDetails('${o.id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2">
                                <i class="ph ph-eye"></i> View Details
                            </button>
                            <div class="px-4 py-2 border-t border-gray-100 dark:border-gray-700">
                                <label class="text-xs text-gray-500 dark:text-gray-400 font-semibold">Change Status</label>
                                <select onchange="updateOrderStatus('${o.id}', this.value)" class="mt-1 w-full text-xs border rounded p-1 bg-white dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600">
                                    <option value="">Select Status</option>
                                    <option value="Order Placement" ${o.status==='Order Placement'?'selected':''}>Placed</option>
                                    <option value="Order Confirmation" ${o.status==='Order Confirmation'?'selected':''}>Confirmed</option>
                                    <option value="Packaging & Dispatch" ${o.status==='Packaging & Dispatch'?'selected':''}>Packed</option>
                                    <option value="Shipping & Tracking" ${o.status==='Shipping & Tracking'?'selected':''}>Shipped</option>
                                    <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                                    <option value="To Review" ${o.status==='To Review'?'selected':''}>To Review</option>
                                    <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
                                </select>
                            </div>
                            <button onclick="markOrderDelivered('${o.id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2 border-t border-gray-100 dark:border-gray-700 mt-1">
                                <i class="ph ph-check-circle"></i> Mark Delivered
                            </button>
                            <button onclick="cancelOrder('${o.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2">
                                <i class="ph ph-x-circle"></i> Cancel Order
                            </button>
                            <button onclick="deleteItem('order', '${o.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2">
                                <i class="ph ph-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('website-list-body').innerHTML = websites.map(w => `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700"><td class="px-6 py-4 font-medium dark:text-white">${w.name}</td><td class="px-6 py-4 text-blue-500"><a href="${w.url}" target="_blank">${w.url}</a></td><td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs ${w.status==='Active'?'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300':'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}">${w.status}</span></td><td class="px-6 py-4 text-right"><button onclick="deleteItem('website', ${w.id})" class="text-red-500 text-sm">Delete</button></td></tr>`).join('');
            document.getElementById('reviews-list-body').innerHTML = reviews.map(r => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700">
                    <td class="px-6 py-4 font-medium dark:text-white">${r.author}</td>
                    <td class="px-6 py-4 text-yellow-500 font-bold">${r.rating} ★</td>
                    <td class="px-6 py-4 text-gray-500 dark:text-gray-400 truncate max-w-xs">${r.comment}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${r.status === 'approved' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300'}">
                            ${r.status || 'pending'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="toggleReviewStatus('${r.id}')" class="text-sm font-medium ${r.status === 'approved' ? 'text-yellow-600 hover:text-yellow-800' : 'text-green-600 hover:text-green-800'}">
                            ${r.status === 'approved' ? 'Unapprove' : 'Approve'}
                        </button>
                        <button onclick="deleteItem('review', '${r.id}')" class="text-red-500 text-sm ml-4">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderUsers() {
             const search = document.getElementById('user-search').value.toLowerCase();
             let filteredUsers = users.filter(u => 
                (u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search)) &&
                u.role === 'Customer'
            );
            document.getElementById('user-list-body').innerHTML = filteredUsers.map(u => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-50 dark:border-gray-700">
                    <td class="px-6 py-4"><input type="checkbox" onchange="toggleSelectUser(${u.id})" ${selectedUsers.includes(u.id) ? 'checked' : ''}></td>
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${u.name}<br><span class="text-xs text-gray-500 dark:text-gray-400">${u.email}</span></td>
                    <td class="px-6 py-4"><span class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-1 px-2 rounded text-xs">${u.role}</span></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs ${u.status === 'Active' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'}">${u.status}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${u.joined || 'N/A'}</td>
                    <td class="px-6 py-4 text-right relative group">
                        <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white"><i class="ph ph-dots-three-vertical text-xl"></i></button>
                        <div class="absolute right-0 top-8 bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-100 dark:border-gray-700 hidden group-hover:block z-10 w-32 py-1">
                            <button onclick="openUserModal(${u.id})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Edit</button>
                            <button onclick="toggleUserStatus(${u.id})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">${u.status === 'Active' ? 'Block' : 'Unblock'}</button>
                            <button onclick="deleteItem('user', ${u.id})" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-50 dark:hover:bg-gray-700">Delete</button>
                        </div>
                    </td>
                </tr>`).join('');
            document.getElementById('user-pagination-info').innerText = `Showing ${filteredUsers.length} users`;
        }

        function deleteItem(type, id) {
            if(!confirm('Are you sure?')) return;
            if(type==='product') products = products.filter(p => p.id !== id);
            if(type==='website') websites = websites.filter(w => w.id !== id);
            if(type==='user') users = users.filter(u => u.id !== id);
            if(type==='review') reviews = reviews.filter(r => r.id !== id);
            if(type==='order') orders = orders.filter(o => o.id != id);
            saveData();
        }

        function toggleReviewStatus(reviewId) {
            const i = reviews.findIndex(r => r.id === reviewId);
            if (i !== -1) {
                reviews[i].status = reviews[i].status === 'approved' ? 'pending' : 'approved';
                saveData();
                showToast(`Review status updated to ${reviews[i].status}`);
                logAction(`Review #${reviewId} status updated to ${reviews[i].status}`);
            }
        }

        function updateOrderStatus(id, s) {
            const i = orders.findIndex(o => o.id == id);
            if (i !== -1) {
                orders[i].status = s;
                saveData();
                showToast('Order updated');
                logAction(`Order #${id} status: ${s}`);
            }
        }

        function markOrderDelivered(id) {
            updateOrderStatus(id, 'To Review');
        }

        function cancelOrder(id) {
            updateOrderStatus(id, 'Cancelled');
        }

        function viewOrderDetails(id) {
            const ord = orders.find(o => o.id == id);
            if (!ord) { 
                showToast('Order not found', 'error'); 
                return; 
            }

            // Populate order header
            document.getElementById('modal-order-id').textContent = ord.id || '-';
            document.getElementById('modal-order-date').textContent = ord.orderDate || new Date().toLocaleDateString();
            document.getElementById('modal-order-status').textContent = ord.status || '-';
            document.getElementById('modal-order-total').textContent = '৳' + (ord.total || 0);

            // Populate customer information
            document.getElementById('modal-cust-name').textContent = ord.customerName || ord.customer || '-';
            document.getElementById('modal-cust-email').textContent = ord.customerEmail || '-';
            document.getElementById('modal-cust-phone').textContent = ord.customerPhone || '-';
            document.getElementById('modal-cust-id').textContent = ord.customerId || '-';

            // Populate billing address
            const billingAddr = ord.billingAddress || {};
            document.getElementById('modal-addr-street').textContent = billingAddr.street || '-';
            document.getElementById('modal-addr-city').textContent = billingAddr.city || '-';
            document.getElementById('modal-addr-postal').textContent = billingAddr.postalCode || '-';
            document.getElementById('modal-addr-country').textContent = billingAddr.country || '-';

            // Populate payment information
            const paymentInfo = ord.paymentInfo || {};
            document.getElementById('modal-payment-method').textContent = paymentInfo.method || ord.payment || '-';
            document.getElementById('modal-payment-status').textContent = paymentInfo.status || ord.paymentStatus || '-';
            document.getElementById('modal-payment-date').textContent = paymentInfo.date || ord.paymentDate || '-';

            // Handle bank payment details if applicable
            const bankDetails = document.getElementById('modal-bank-details');
            if (paymentInfo.method === 'Bank Transfer' || paymentInfo.bankDetails) {
                bankDetails.classList.remove('hidden');
                const bank = paymentInfo.bankDetails || {};
                document.getElementById('modal-bank-name').textContent = bank.bankName || '-';
                document.getElementById('modal-bank-account').textContent = bank.accountNumber || '-';
                document.getElementById('modal-bank-ref').textContent = bank.transactionRef || '-';
                document.getElementById('modal-bank-doctype').textContent = bank.documentType || '-';

                // Show bank document if available
                const bankDocSection = document.getElementById('modal-bank-doc');
                if (bank.documentImage) {
                    bankDocSection.classList.remove('hidden');
                    document.getElementById('modal-bank-doc-img').src = bank.documentImage;
                } else {
                    bankDocSection.classList.add('hidden');
                }
            } else {
                bankDetails.classList.add('hidden');
            }

            // Populate order items
            const itemsBody = document.getElementById('modal-order-items');
            if (ord.items && ord.items.length > 0) {
                itemsBody.innerHTML = ord.items.map(item => {
                    const subtotal = (item.quantity || 0) * (item.price || 0);
                    return `
                        <tr>
                            <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">${item.name || 'N/A'}</td>
                            <td class="px-4 py-3 text-center">${item.quantity || 0}</td>
                            <td class="px-4 py-3">৳${(item.price || 0).toLocaleString()}</td>
                            <td class="px-4 py-3 text-right font-semibold">৳${subtotal.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                itemsBody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">No items in order</td></tr>';
            }

            // Populate order summary
            const subtotal = ord.subtotal || ord.total || 0;
            const shipping = ord.shippingCost || 0;
            const tax = ord.tax || 0;
            const total = ord.total || 0;

            document.getElementById('modal-subtotal').textContent = '৳' + subtotal.toLocaleString();
            document.getElementById('modal-shipping').textContent = '৳' + shipping.toLocaleString();
            document.getElementById('modal-tax').textContent = '৳' + tax.toLocaleString();
            document.getElementById('modal-total-final').textContent = '৳' + total.toLocaleString();

            // Populate delivery information
            const delivery = ord.deliveryInfo || {};
            document.getElementById('modal-delivery-type').textContent = delivery.type || ord.type || '-';
            document.getElementById('modal-delivery-date').textContent = delivery.estimatedDate || '-';
            document.getElementById('modal-tracking-number').textContent = delivery.trackingNumber || '-';

            // Populate additional information
            document.getElementById('modal-order-placed').textContent = ord.createdAt || ord.orderDate || new Date().toLocaleString();
            document.getElementById('modal-last-updated').textContent = ord.updatedAt || new Date().toLocaleString();
            document.getElementById('modal-notes').textContent = ord.notes || '-';

            // Open modal
            toggleModal('orderDetailsModal', true);
        }

        function printOrder() {
            const orderId = document.getElementById('modal-order-id').textContent;
            const printWindow = window.open('', '', 'height=600,width=800');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Order #${orderId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .section { margin-bottom: 20px; page-break-inside: avoid; }
                        .section h3 { border-bottom: 2px solid #D9232D; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f3f4f6; font-weight: bold; }
                        .total-section { text-align: right; margin-top: 20px; }
                        .total-row { font-size: 18px; font-weight: bold; color: #D9232D; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>NOKLITY Order Confirmation</h1>
                        <p>Order #${orderId}</p>
                    </div>
                    <div class="section">
                        <h3>Customer Information</h3>
                        <p><strong>Name:</strong> ${document.getElementById('modal-cust-name').textContent}</p>
                        <p><strong>Email:</strong> ${document.getElementById('modal-cust-email').textContent}</p>
                        <p><strong>Phone:</strong> ${document.getElementById('modal-cust-phone').textContent}</p>
                    </div>
                    <div class="section">
                        <h3>Delivery Address</h3>
                        <p>${document.getElementById('modal-addr-street').textContent}</p>
                        <p>${document.getElementById('modal-addr-city').textContent}, ${document.getElementById('modal-addr-postal').textContent}</p>
                        <p>${document.getElementById('modal-addr-country').textContent}</p>
                    </div>
                    <div class="section">
                        <h3>Payment Information</h3>
                        <p><strong>Method:</strong> ${document.getElementById('modal-payment-method').textContent}</p>
                        <p><strong>Status:</strong> ${document.getElementById('modal-payment-status').textContent}</p>
                    </div>
                    <div class="section">
                        <h3>Order Items</h3>
                        <table>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Subtotal</th>
                            </tr>
                            ${Array.from(document.querySelectorAll('#modal-order-items tr')).map(row => 
                                '<tr>' + Array.from(row.querySelectorAll('td')).map(cell => `<td>${cell.textContent}</td>`).join('') + '</tr>'
                            ).join('')}
                        </table>
                    </div>
                    <div class="total-section">
                        <p><strong>Subtotal:</strong> ${document.getElementById('modal-subtotal').textContent}</p>
                        <p><strong>Shipping:</strong> ${document.getElementById('modal-shipping').textContent}</p>
                        <p><strong>Tax:</strong> ${document.getElementById('modal-tax').textContent}</p>
                        <p class="total-row"><strong>Total:</strong> ${document.getElementById('modal-total-final').textContent}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function markOrderDelivered(id) {
            if (!confirm('Mark this order as Delivered?')) return;
            updateOrderStatus(id, 'Delivery');
        }

        function cancelOrder(id) {
            if (!confirm('Cancel this order?')) return;
            updateOrderStatus(id, 'Cancelled');
        }

        function openUserModal(editId = null, isStaff = false) {
            document.getElementById('userForm').reset();
            document.getElementById('u-id').value = '';
            const roleSelect = document.getElementById('u-role');
            
            if(isStaff) {
                roleSelect.value = 'Admin';
            } else {
                roleSelect.value = 'Customer';
            }

            if (editId) {
                const u = users.find(user => user.id === editId);
                if (u) {
                    document.getElementById('userModalTitle').innerText = 'Edit ' + (u.role === 'Customer' ? 'Customer' : 'User');
                    document.getElementById('u-id').value = u.id;
                    document.getElementById('u-name').value = u.name;
                    document.getElementById('u-email').value = u.email;
                    document.getElementById('u-role').value = u.role;
                    document.getElementById('u-status').value = u.status;
                }
            } else {
                document.getElementById('userModalTitle').innerText = isStaff ? 'Add New Staff' : 'Add New Customer';
            }
            toggleModal('userModal', true);
        }
        
        function submitProductForm() {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            
            if (!name || !price) {
                showToast('Please fill in product name and price', 'error');
                return;
            }

            const id = document.getElementById('p-id').value;
            const newProduct = {
                id: id ? Number(id) : Date.now(),
                name: name,
                price: Number(price),
                originalPrice: Number(document.getElementById('p-discount').value) || null,
                category: document.getElementById('p-category').value,
                stock: Number(document.getElementById('p-stock').value),
                description: document.getElementById('p-desc').value,
                specifications: document.getElementById('p-specs').value,
                shippingInfo: document.getElementById('p-shipping').value,
                returnPolicy: document.getElementById('p-return').value,
                faqs: document.getElementById('p-faqs').value,
                relatedIds: document.getElementById('p-related').value,
                status: document.getElementById('p-status') ? document.getElementById('p-status').value : 'Active',
                images: tempImages.slice(),
                featuredIndex: tempImages.length ? tempFeaturedIndex : undefined,
                imageUrl: (tempImages && tempImages[tempFeaturedIndex]) ? tempImages[tempFeaturedIndex] : 'https://via.placeholder.com/150'
            };

            if (id) {
                const idx = products.findIndex(p => p.id == id);
                if (idx !== -1) products[idx] = newProduct;
            } else {
                products.push(newProduct);
            }
            
            saveData();
            toggleModal('productModal', false);
            showToast('Product saved successfully');
        }
        
        function openProductModal(editId = null) {
            // Reset form
            document.getElementById('productForm').reset();
            document.getElementById('p-id').value = '';
            tempImages = [];
            tempFeaturedIndex = 0;
            switchTab('tab-general');

            if (editId) {
                const p = products.find(prod => prod.id === editId);
                if (p) {
                    document.getElementById('productModalTitle').innerText = 'Edit Product';
                    document.getElementById('p-id').value = p.id;
                    document.getElementById('p-name').value = p.name;
                    document.getElementById('p-price').value = p.price;
                    document.getElementById('p-discount').value = p.originalPrice || '';
                    if (typeof p.featuredIndex === 'number' && p.featuredIndex >= 0 && p.featuredIndex < tempImages.length) tempFeaturedIndex = p.featuredIndex;
                    else if (p.imageUrl) tempFeaturedIndex = tempImages.indexOf(p.imageUrl) >= 0 ? tempImages.indexOf(p.imageUrl) : 0;
                    renderImagePreviews();
                }
            } else {
                document.getElementById('productModalTitle').innerText = 'Add New Product';
                renderImagePreviews();
            }
            toggleModal('productModal', true);
        }

        // Gemini & AI Functions
        async function callGemini(prompt) {
            try {
                if(!apiKey) return "Error: API Key is missing.";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate content.";
            } catch (e) {
                console.error(e);
                return "Error connecting to AI service.";
            }
        }

        async function generateProductDescription() {
            const name = document.getElementById('p-name').value;
            const category = document.getElementById('p-category').value;
            const btn = document.getElementById('btn-generate-desc');
            if(!name) { alert("Please enter a product name first."); return; }
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Generating...`;
            btn.classList.add('pointer-events-none', 'opacity-70');
            const prompt = `Write a compelling description for a ${category} item named "${name}". Keep it under 80 words.`;
            const result = await callGemini(prompt);
            document.getElementById('p-desc').value = result;
            btn.innerHTML = `<i class="ph-fill ph-sparkle"></i> ✨ AI Generate`;
            btn.classList.remove('pointer-events-none', 'opacity-70');
        }

        async function generateAdCopy() {
            const topic = document.getElementById('ai-topic').value;
            const btn = document.getElementById('ai-ad-btn');
            const resultContainer = document.getElementById('ai-result-container');
            if(!topic) { alert("Please enter a topic."); return; }
            btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Working...`;
            btn.classList.add('ai-loading');
            const prompt = `Write a short social media ad copy for: "${topic}". Include emojis.`;
            const result = await callGemini(prompt);
            document.getElementById('ai-ad-result').innerText = result;
            resultContainer.classList.remove('hidden');
            btn.innerHTML = `<i class="ph-fill ph-sparkle"></i> ✨ Generate Ad`;
            btn.classList.remove('ai-loading');
        }
        
        // --- API & Webhooks ---
        function regenerateApiKey() { if(confirm('Regenerate key?')) { apiSettings.apiKey = 'nok_' + Date.now(); saveApiSettings(); renderApiSettings(); showToast('New API Key Generated'); logAction('Regenerated API Key'); } }
        function copyApiKey() { navigator.clipboard.writeText(apiSettings.apiKey); showToast('Key copied'); }
        function deleteWebhook(i) { if(confirm('Delete?')) { apiSettings.webhooks.splice(i,1); saveApiSettings(); renderApiSettings(); showToast('Webhook deleted'); } }
        function openWebhookModal() { const u = prompt('Webhook URL:'); if(u) { apiSettings.webhooks.push({url:u, events:['all']}); saveApiSettings(); renderApiSettings(); showToast('Webhook added'); } }
        function renderApiSettings() { document.getElementById('api-key-display').value = apiSettings.apiKey; document.getElementById('webhook-list-body').innerHTML = apiSettings.webhooks.map((h,i)=>`<tr><td class="px-4 py-2">${h.url}</td><td class="px-4 py-2">All</td><td class="px-4 py-2"><button onclick="deleteWebhook(${i})" class="text-red-500">Delete</button></td></tr>`).join(''); }

        initCharts();
        checkAuth();
    </script>
</body>
</html>